<!DOCTYPE html>
<html>
  <head>
    <title>Google Identity Services Authorization Token model</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
      let client;
      let tokenClient;
      let state;

      function initClient() {
        // https://developers.google.com/discovery/v1/reference/apis/list
        const discoveryRestUrls = {
          sheets: 'https://sheets.googleapis.com/$discovery/rest?version=v4',
        };
        new Promise((callback, onerror) => { 
          gapi.load('client', { callback, onerror });
        })
        .then(() => {
          return gapi.client.init({
            discoveryDocs: [  // preload apis 
              discoveryRestUrls.sheets,
            ]
          });
        })
        .then(() => { 
          client = gapi.client;
          const [token] = [window.localStorage.getItem('token')].map(JSON.parse);
          if (token?.access_token) {
            gapi.client.setToken(token);
          }
          console.log('client initialized');
          updateUi({ initialized: !!tokenClient });
         });
      }
      function initTokenClient() {
        scopes = [
          'https://www.googleapis.com/auth/spreadsheets.readonly',
        ];
        // https://developers.google.com/identity/oauth2/web/guides/use-token-model
        // https://console.cloud.google.com/apis/credentials/oauthclient/588879659786-96ialt5l1bn240naa55eh7gberlo66ds.apps.googleusercontent.com
        tokenClient = google.accounts.oauth2.initTokenClient({  // implicit grant flow
          client_id: '588879659786-96ialt5l1bn240naa55eh7gberlo66ds.apps.googleusercontent.com',
          scope: scopes.join(' '),
          prompt: '',  // instead of `consent`
          callback: ''
        });
        console.log('token client initialized');
        updateUi({ initialized: !!client });
      }
      function signIn() {
        return new Promise((resolve, reject) => {
          tokenClient.callback = ({ error }) => {
            if (error) { reject(error) }
            else { resolve() }  // gapi.client.getToken() is updated automatically
          };
          tokenClient.requestAccessToken();
        })
        .then(() => { 
          window.localStorage.setItem('token', JSON.stringify(gapi.client.getToken()));
          console.log('authenticated');
          updateUi({ authenticated: true });
        });
      }
      function signOut() {
        const credentials = gapi.client.getToken();
        if (credentials) {
          google.accounts.oauth2.revoke(credentials.access_token, () => { 
            gapi.client.setToken('');
            window.localStorage.removeItem('token');
            console.log('token revoked');
            updateUi({ tokenRevoked: true });
          });
        }
      }
      function loadSpreadsheetValues() {
        updateUi({ loadingValues: true });
        // https://developers.google.com/sheets/api/reference/rest/v4/spreadsheets.values/get
        gapi.client.sheets.spreadsheets.values.get({ 
          spreadsheetId: '1ZX6U4o0rUuA-uj2UbwDNSd-JhJBeqb6WkwsEWh_ARWs',
          range: 'BAL',  
        })
        .then(({ result, status }) => { 
          if (status == 200) {
            console.log('values loaded');
            updateUi({ values: result.values });
          }
        })
        .catch((error) => {
          if (error?.status === 401 || error?.status === 403) {
            gapi.client.setToken('');
            window.localStorage.removeItem('token');
            console.log('unauthorized');
            updateUi({ unauthorized: true, loadingValuesError: error });
          }
        });
      }
      function handleTBodyClick(event) {
        if (event.target instanceof HTMLTableCellElement) {
          const { col } = event.target.dataset;
          const { month, account } = event.target.parentElement.dataset;
          updateUi({ toggle: { col, month, account }});
        }
      }
      function updateUi(event = {}) {
        if (event.initialized) {
          updateUiLoadingClient({ visible: false });
          updateUiVisibility();
          if (gapi.client.getToken()?.access_token) {
            loadSpreadsheetValues();
          }
        }
        if (event.authenticated) {
          updateUiVisibility();
          loadSpreadsheetValues();
        }
        if (event.tokenRevoked) {
          updateUiVisibility();
          updateUiValuesTable({});   // clear table
        }
        if (event.loadingValues) {
          updateUiLoadingValues({ visible: true });
        }
        if (event.loadingValuesError) {
          updateUiLoadingValues({ visible: false });
        }
        if (event.values) {
          updateUiLoadingValues({ visible: false });
          const { values } = event;
          const index = new Map(values[0].map((x,i) => [x,i]));
          const header = values.shift().filter(x => ['DT','AMNT','ACCT'].includes(x));
          state = { index, filter: new Set() };
          updateUiValuesTable({ index, header, values });
        }
        if (event.toggle) {
          const { col, month, account } = event.toggle;
          const { filter } = state;
          if (['DT','ACCT'].includes(col)) {
            if (filter.has(col)) {
              filter.delete(col);
            } else {
              filter.add(col);
            }
            updateUiFilterValuesTable(filter, { month, account });
          }
        }
      }
      function updateUiValuesTable({ index, header, values }) {
        [document.querySelector('.div-values table')].filter(Boolean).forEach(table => {
          [document.createElement('thead')].forEach(thead => {
            table.tHead?.remove();
            if (header) {
              [document.createElement('tr')].forEach(tr => {
                header.map(col => [document.createTextNode(col), document.createElement('th')])
                  .forEach(([text, th]) => {
                    th.appendChild(text);
                    tr.appendChild(th);
                  });
                thead.appendChild(tr);
              });
            }
            table.appendChild(thead);
          });

          [document.createElement('tbody')].forEach(tbody => {
            const [tBody] = Array.from(table.tBodies);
            tBody?.remove();
            if (values) {
              const highlight = makeAlternateHighlight();
              values.map(row => [row, document.createElement('tr')])
                .forEach(([row, tr]) => {
                  header.map(col => [col, row[index.get(col)]])
                    .map(([col, value]) => [col, document.createTextNode(value), document.createElement('td')])
                    .forEach(([col, text, td]) => {
                      td.dataset.col = col;
                      td.appendChild(text);
                      tr.appendChild(td);
                    });
  
                  tr.dataset.account = row[index.get('ACCT')];
                  tr.dataset.month = new Intl.DateTimeFormat('en', { year: 'numeric', month: 'numeric' }).format(new Date(row[index.get('DT')]));
                  tr.dataset.date = row[index.get('DT')];
                  highlight(tr);
                  tbody.appendChild(tr);
                });
              tbody.addEventListener('click', handleTBodyClick);
            }
            table.appendChild(tbody);
          });
        });
      }
      function updateUiFilterValuesTable(filter, { month, account }) {
        const attributes = [
          filter.has('DT') && `[data-month='${month}']`,
          filter.has('ACCT') && `[data-account='${account}']`,
        ].filter(Boolean).join('');
        
        [document.querySelector('.div-values table')].filter(Boolean).forEach(table => {
          const [tbody] = Array.from(table.tBodies);
          const highlight = makeAlternateHighlight();
          if (attributes) {
            tbody.querySelectorAll(`tr:not(:where(tr${attributes}))`).forEach(tr => { 
              tr.classList.toggle('d-none', true);
            });
            tbody.querySelectorAll(`tr${attributes}`).forEach(tr => { 
              tr.classList.toggle('d-none', false);
              highlight(tr);
            });
          } else {
            tbody.querySelectorAll('tr').forEach(tr => { 
              tr.classList.toggle('d-none', false);
              highlight(tr);
            });
          }
        });
      }
      function updateUiVisibility() {
        updateUiLogin({ visible: !client.getToken(), disabled: !!client.getToken() });
        updateUiLogout({ visible: !!client.getToken(), disabled: !client.getToken() });
        updateUiValues({ visible: !!client.getToken() });
      }
      function updateUiLogin({ visible, disabled }) {
        [document.querySelector('.btn-login')].filter(Boolean).forEach(el => {
          el.disabled = disabled;
          el.classList.toggle('d-none', !visible);
        });
      }
      function updateUiLogout({ visible, disabled }) {
        [document.querySelector('.btn-logout')].filter(Boolean).forEach(el => {
          el.disabled = disabled;
          el.classList.toggle('d-none', !visible);
        });
      }
      function updateUiValues({ visible }) {
        [document.querySelector('.div-values')].filter(Boolean).forEach(el => {
          el.classList.toggle('d-none', !visible);
        });
      }
      function updateUiLoadingValues({ visible }) {
        [document.querySelector('.label-loading-values')].forEach(el => {
          el.classList.toggle('d-none', !visible);
        });
      }
      function updateUiLoadingClient({ visible }) {
        [document.querySelector('.label-loading-client')].forEach(el => {
          el.classList.toggle('d-none', !visible);
        });
      }
      function makeAlternateHighlight() {
        let lastDt;
        let highlight = true;
        return function (tr) {
          if (lastDt !== tr.dataset.date) {
            highlight = !highlight;
            lastDt = tr.dataset.date;
          }
          tr.classList.toggle('highlighted', highlight);
        }
      }
    </script>
    <script src="https://apis.google.com/js/api.js" onload="initClient()" async defer></script>
    <script src="https://accounts.google.com/gsi/client" onload="initTokenClient()" async defer></script>    
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        display: flex;
        flex-direction: column;
        height: 100%;
        margin: 0px;
        padding: 8px;
        position: absolute;
        row-gap: 8px;
        width: 100%;
      }
      .div-values {
        flex: 1 1 auto;
        overflow: auto;
      }
      .div-values table {
        border-spacing: 0px;
        width: 100%;
      }
      .div-values table thead tr {
        background-color: gray;
        color: white;
        position: sticky;
        top: 0px;
      }
      .d-none {
        display: none;
      }
      .highlighted {
        background-color: lightgray;
      }
    </style>
  </head>
  <body>
    <p class="label-loading-client">Loading...</p>
    <div>
      <button class="btn-login d-none" onclick="signIn()" disabled>Sign In</button>
      <button class="btn-logout d-none" onclick="signOut()" disabled>Sign Out</button>
    </div>
    <p class="label-loading-values d-none">Loading values...</p>
    <div class="div-values d-none">
      <table></table>
    </div>
  </body>
</html>